# simp-packer

[Packer][packer] tooling to create Beaker-capable [Vagrant][vagrant] `.box`es from
[SIMP][simp] ISOs for the purpose of CI testing full SIMP installations.


<!-- vim-markdown-toc GFM -->

* [Overview](#overview)
* [Setup](#setup)
* [Usage](#usage)
  * [Environment variables](#environment-variables)
  * [Using Packer to test a SIMP environment](#using-packer-to-test-a-simp-environment)
  * [Defining a packer build](#defining-a-packer-build)
  * [Running a build](#running-a-build)
    * [Output](#output)
* [Reference](#reference)
  * [Project structure](#project-structure)
  * [The Packer file](#the-packer-file)
    * [Build Section](#build-section)
    * [Provisioning Section](#provisioning-section)
  * [The Vagrantfile](#the-vagrantfile)
  * [Default SIMP server environment](#default-simp-server-environment)
* [Troubleshooting & common problems](#troubleshooting--common-problems)
  * [Building the boxes](#building-the-boxes)
    * [`fatal error: runtime: out of memory`](#fatal-error-runtime-out-of-memory)
    * [`Post-processor failed:` ... `no space left on device`](#post-processor-failed--no-space-left-on-device)
* [Development](#development)
  * [Contributing to `simp-packer`](#contributing-to-simp-packer)
  * [Travis pipeline](#travis-pipeline)
* [TODO](#todo)
  * [Documentation](#documentation)
  * [Tests](#tests)
  * [Features](#features)
  * [Cleanup](#cleanup)

<!-- vim-markdown-toc -->

## Overview

![simp-packer basics][simp-packer-basics]

* `simp-packer` supports SIMP >= 6.0.0-0.
* The Vagrant boxes use the Virtualbox hypervisor, and are built using the Vagrant's [virtualbox-iso][vagrant-virtualbox-iso] builder.

[simp-packer-basics]: assets/simp-packer-basics.png

## Setup

Requirements:

* [VirtualBox](https://www.virtualbox.org/wiki/Downloads)
* [Vagrant](https://www.vagrantup.com/downloads.html)
* [Packer](https://www.packer.io/downloads.html) is distributed as a binary.

  - Ensure the binary is in your `$PATH` and comes before any other packer
    executables on the system (e.g., `export PATH="/path/to/packer:$PATH"`).
  - `simp-packer` 2.* requires `packer` version 1.2.4 or later. This update is
    to support UEFI boot of SIMP servers. Since VirtualBox does not support
    UEFI tftpboot, the SIMP clients will use legacy BIOS boot.

* A [SIMP][SIMP] ISO (`.iso`) file. Either an official release or one generated
  by [simp-core](https://github.com/simp/simp-core) build commands.
  * _(Optional, but useful:)_ The `.json` "vars" file that was generated along
    with the SIMP `.iso` file. This file is generated by the SIMP ISO build
    process.


## Usage

### Environment variables

* The [Environment Variables for Packer][packer-env-vars] are useful to customize builds.
* Other important variables:

| Variable | Description |
| -------- | ----------- |
| **`EXTRA_SIMP_PACKER_ARGS`** | Injects extra CLI arguments during `packer build` |
| **`TMP_DIR`**               | This is a critical [packer variable][packer-env-vars] that deserves special mention: this location _must_ be able to store over 4GB as the box is built.  The default location is `/tmp`, which on many systems is unable to store that much data.  |




### Using Packer to test a SIMP environment

### Defining a packer build

Create a **test directory**, and include the following files:

* `vars.json`:  The JSON file corresponding with the SIMP ISO.  Contains
  variables that point to the ISO, the ISO checksum, the name of the
  distribution ISO, and the `root` password. Samples can be found in
  `samples/<sample>/vars.json`.
* `simp_conf.yaml`:  YAML generated by `simp config`.  You can use a copy of
  one from a previous build or edit one from from
  `samples/<sample>/simp_conf.yaml`. Puppet server and FIPS configurations will
  be overridden by `simp_config.rb` and `packer.yaml`.
* `packer.yaml`:  Overrides defaults set in `simp_config.rb`.  Packer requires
  this file (even if you don't want to override defaults). Samples can be found
  in `samples/<sample>/packer.yaml`.  For CentOS 6 builds, you **MUST** change
  the `nat_interface` and `host_only_interface` to `eth0` and `eth1`,
  respectively.

See [samples/README.md](samples/README.md) for more information.

### Running a build

`TMPDIR=/some/tmp/dir ./simp_packer_test.sh /path/to/test/directory`

- `simp_packer_test.sh` must be run from the top level of the `simp-packer`
  directory.
- `packer` uses around twice the space of the virtual image footprint when
  building, so ensure `TMPDIR` has sufficient space.  `TMPDIR` defaults to
  `/tmp` which is not (usually) large enough.


#### Output

- A working directory will be created under the test directory, where all the
  scripts, manifests, and files are kept. It is erased on completion of the
  test, but can be preserved with `SIMP_PACKER_save_WORKINGDIR=true`.
- A time-stamped log file is created in the top level of the test directory and
  all the log output from `packer` is copied there. If the `packer` build
  fails, it is renamed from `<date>.log` to `<date>.log.errors`.
- A Vagrant box with its VagrantFile will be located in the directory defined
  by the `packer.yaml file` `output_directory` (default is
  `<testdirectory>/OUTPUT`).

## Reference


### Project structure

```
.
├── assets/ ................ Images used by README.md
├── lib/                     Ruby libraries
├── metadata.json
├── puppet/                  ‡Puppet code (run inside VM)
│   └── modules/               ‡ contains `simpsetup::`
├── rakelib/ ............... Rake tasks
├── README.md
├── samples/
│   └── README.md
├── scripts/................ ‡ Shell scripts (run inside VM)
│   ├── config/                 ‡ scripts that configure the VM
│   ├── tests/                  ‡ VM tests
├── simp_config.rb*
├── simp_packer_test.sh* ...
├── templates/
│   ├── simp.json.template
│   └── Vagrantfile.erb
└── test.sh
```

‡ = Used inside VMs when simp-packer builds boxes


### The Packer file

The packer file is generated from `simp.json.template`

#### Build Section

- Installs the ISO
- Adds the `vagrant` user
- Sets `root`'s umask
- Configures the network to start up a boot time
- Changes the passwords for `simp` and `root`
- Updates the `sudoers` file so `simp` user can sudo without a password and
  without a tty

#### Provisioning Section

Runs a suite of tests:

- Checks that FIPS was enabled/disabled per configuration.
- Runs `simp config` and `simp bootstrap`.
- Installs a manifest that configures the `vagrant` user so you can `vagrant
  ssh` once the box is built, configures `simp` user so `packer` can continue
  working
- Reboots and runs Puppet a couple of times.
- Ensures that the build of the puppetserver is successful and the puppetserver
  is up and running and listening on the ports configured in `simp_conf.yaml`.
- Verifies that FIPS is setting match across the `simp_conf.yaml`, the
  `simp_config_settings.yaml` and the operational environment.
- Checks that selinux is set to `enforcing` (the default for simp.)
- If `simp_crypt_disk` is used in the `simp.conf`, it verifies that the disk is
  encrypted.
- Verifies that `/`, `/var/`,`/var/audit` are separate partitions.
- Checks that the port in `puppet.conf` file matches the port in
  `simp_conf.yaml`

If the tests pass, it will configure the Puppet server.  The `simpsetup`
module is applied using `puppet apply`.  It is run once so that if you make
changes later on they are not overwritten. This module does the following:

- Sets up the kickstart files
- Sets up DNS
- Sets up TFTP manifests
- Runs the FakeCA `togen` script to generate SIMP application certificates for
  the SIMP server and all the clients pre-configured in DHCP and DNS.
- Adds users and groups into LDAP
- Sets up autosign to be `*.<domain name>`, so kickstarted systems will get
  their Puppet certificates autosigned.
- Runs scripts that edit the `site.pp` file to create some hostgroups and the
  SIMP server's hiera file to include kickstart and tftpboot classes.
- Copies into the `site` module, but does not use, other useful manifests site
  such as `workstation.pp` and `nfs.pp`.  These manifests will be refined as
  the test suite is expanded.
- Runs puppet once more

The post-processor then exports the VirtualBox to a Vagrant box and removes the
output directory.


### The Vagrantfile

- The `vagrant` user's SSH password is `vagrant`.
- The Vagrantfile is not wrapped in the Vagrant `.box`, so the network
  settings can be seen. Vagrant is not easily configured to check if a vbox
  hostonly network exists; you will have to ensure the network exists before
  running `vagrant up`.
- You can change the network name in the Vagrant file.
   - [ ]  FIXME: verify that this is not a problem with beaker
- The Vagrantfile does not configure the machine to _use_ its IP address.
  You can turn it on, but changing the IP address will mess up the puppet
  server.
- Directory sharing is enabled.


### Default SIMP server environment

- The Puppet server's IP will be `X.X.X.7`
- DHCP and DNS are pre-populated with entries for `server21.domain.name`
  through `server29.domain.name`, and `ws31.domain.name` to `ws39.domain.name`.
  - Each host's IP and MAC will match the hostname's number: e.g., `server21`
    will have the IP `X.X.X.21` and the MAC address `XX:XX:XX:XX:XX:21`.
- FIXME: (verify what everything means) The default password for everything is `P@ssw0rdP@ssw0rd`. You can change the
  default in `vars.json` with `new_password`.  However, at this time, there is
  no mechanism to change the LDAP Password.
- The SIMP server is configured to be an LDAP server:
  - The `basedn` will match the `packer.yaml`'s `domain` (or use the default).
  - Basic LDAP users are included: `user1`, `user2`, `admin1`, `admin2`
    - `admin1` and `admin2` are in the `administrators` group.
- The default distribution's ISO path is `/net/ISO/Distribution_ISOs`. This is
  currently hard-coded in `simp.json.template`.

## Troubleshooting & common problems

### Building the boxes

#### `fatal error: runtime: out of memory`

This error is generally encountered during the OS ISO upload, and it means what it
says: the host machine that is building the VM has run out of available RAM

**Characteristic log snippet:**

```
2018/08/13 15:38:35 ui: ==> virtualbox-iso: Uploading /path/to/ISO/CentOS-7-x86_64-DVD-1708.iso => /var/local/simp/CentOS-7-x86
_64-DVD-1708.iso
==> virtualbox-iso: Uploading /path/to/ISO/CentOS-7-x86_64-DVD-1708.iso => /var/local/simp/CentOS-7-x86_64-DVD-1708.iso
2018/08/13 15:38:35 packer: 2018/08/13 15:38:35 [DEBUG] Opening new ssh session
2018/08/13 15:38:35 packer: 2018/08/13 15:38:35 [DEBUG] Starting remote scp process:  scp -vt /var/local/simp
2018/08/13 15:38:35 packer: 2018/08/13 15:38:35 [DEBUG] Started SCP session, beginning transfers...
2018/08/13 15:38:35 packer: 2018/08/13 15:38:35 [DEBUG] scp: Uploading CentOS-7-x86_64-DVD-1708.iso: perms=C0600 size=4521459712
2018/08/13 15:38:43 packer: fatal error: runtime: out of memory
2018/08/13 15:38:43 packer:
2018/08/13 15:38:43 packer: runtime stack:
2018/08/13 15:38:43 packer: runtime.throw(0x2314ecc, 0x16)
2018/08/13 15:38:43 packer:     /usr/local/go/src/runtime/panic.go:616 +0x81
```


#### `Post-processor failed:` ... `no space left on device`

`simp_config.rb` configures the vagrant post-processor to write the `.box` file
into the `<testingdirectory>/OUTPUT` directory, or the path of
`output_directory` if it is defined by the `packer.yaml` file.  If this
location does not have the capacity to hold the box while it is being
constructed, it will fail.

**Characteristic log snippet:**

```
==> virtualbox-iso: Running post-processor: vagrant
==> virtualbox-iso (vagrant): Creating Vagrant box for 'virtualbox' provider
    virtualbox-iso (vagrant): Copying from artifact: OUTPUT/packer-virtualbox-iso-1454117110-disk1.vmdk
Build 'virtualbox-iso' errored: 1 error(s) occurred:

* Post-processor failed: write /tmp/packer040362584/packer-virtualbox-iso-1454117110-disk1.vmdk: no space left on device

==> Some builds didn't complete successfully and had errors:
--> virtualbox-iso: 1 error(s) occurred:

* Post-processor failed: write /tmp/packer040362584/packer-virtualbox-iso-1454117110-disk1.vmdk: no space left on device

==> Builds finished but no artifacts were created.
```


## Development

### Contributing to `simp-packer`

Please read our [Contribution Guide][simp-contrib].

If you find any issues, they can be submitted to our [JIRA][simp-jira].

To see a list of development-related tasks available for this project, run:

      bundle exec rake -T

### Travis pipeline

**Validation:**

* Ruby code is linted with [rubocop][rubocop], using `bundle exec rake
  test:rubocup`.
* Shell scripts are linted with [shellcheck][shellcheck], using `bundle exec
  test:shellcheck`.
  * _(The `shellcheck` binary is is now built into Travis CI environments, even
    for `language: ruby`!)_
  * **NOTE:** The version of `shellcheck` on Travis CI may be different than
    your local development environment.  In particular, the EL7 EPEL `ShellCheck`
    package is much older (0.35 vs 0.45+)—in practice, this has generally
    meant that `shellcheck` in Travis CI catches more nuanced errors.
* Puppet code and metadata is linted as part of the
  `test:puppet` rake task.  At the moment, only Puppet code  under
  `puppet/modules/` is linted.

**Puppet (SIMP versions):**

* All Puppet modules under the `puppet/modules/` directory will be tested
  using `bundle exec rake test:puppet`.
* The Travis CI pipeline matrix only considers the versions of Puppet used in
  SIMP along with the latest 5.x (which is informational, and allowed to fail).


## TODO

### Documentation

- [ ] Verify documentation
  - [ ] FIXME comments in `README.md`
- [x] Environment Variables
- [ ] What does `simp_config.rb` do?
- [ ] The purpose of simp-packer
- [x] Contribution/Development

### Tests

- [x] Asset tests _(phase 1—low-hanging fruit)_:
  - [x] [Shellcheck][shellcheck] to lint shell scripts
  - [x] [Rubocop][rubocop] to lint ruby scripts
  - [x] Local Puppet module tests: syntax validation, lint checks, and spec
  - [x] All asset tests should be run from rake tasks
  - [x] Update the Travis CI pipeline to run asset tests
- [ ] Asset tests _(phase 2—more complete)_:
  - [ ] Tests (at least linting) for any non-module puppet manifests?
  - [ ] Validate [packer JSON _schema_][packer-schema]
  - [ ] Spec tests for ruby code (after refactoring into testable components)
        under `lib/`)
  - [ ] Validate packer JSON
  - [ ] Update the GitLab CI pipeline to run asset tests
    - `test:shellcheck` will need a `shellcheck`-capable CI Runner
- [ ] Integration tests during `packer build`:
  - [ ] Test if the SIMP server's YUM repos are setup and working. These are
    the repos the SIMP clients are configured to use.
  - [ ] Check if puppet is actually running on the port you specified using
    `netstat` or `ss`.
  - [ ] Add one last puppet run in at the end and check that it returns 0.
    Since all services including DNS should be set up, nothing should change at
    that point.)

### Features

- [ ] Move the packer build into a rake task
- [x] Refactor reusable host-side ruby code into a `lib/` directory
- [ ] Add an Environment variable in to allow it to create the box even if tests
      fail.
- [ ] Kickstart a server and client to go with the box.
- [ ] Make the location of the distribution ISO configurable.  Right now it is
      hardcoded to be `/net/ISO/Distribution_ISOs`
- [ ] Validate input from `packer.yaml`
- [ ] Don't fail if `packer.yaml` doesn't exist (it should be able to run with
      all the defaults).
- [ ] Compose `simp-packer.json` from JSON snippets
- [ ] Save a version metadata for a `.box` file in Vagrant Cloud API format.
- [ ] Scaffold and maintain a local directory tree (structured like the Vagrant
      Cloud API, and consumable by local `vagrant init` and `vagrant up`
      commands) of `.box` and `.json` version metadata files

### Cleanup

- [ ] Restructure project to place puppet code in one place, ruby another, etc
  - [x] ruby
    - [x] rake tasks
    - [ ] simp_config.rb
  - [ ] puppet
    - [x] modules
    - [ ] right now some Puppet code is embedded as bash heredocs
- [ ] Change the `packer.yaml` settings to match the names used in the
  `simp.json` file to make things more consistent and will allow code
  simplification.
- [ ] Merge the `simp_config.rb` and `simp_packer_tests.sh` into one ruby
  script and clean it up.
- [ ] Delete the Virtualbox host-only network if we created it
- [x] `rake clean` should delete symlinks that will break packer.

[simp]:                    https://github.com/NationalSecurityAgency/SIMP
[simp-contrib]:            https://simp.readthedocs.io/en/master/contributors_guide/
[simp-jira]:               https://simp-project.atlassian.net
[packer]:                  https://packer.io
[packer-schema]:           https://github.com/lostintangent/packer-schema
[vagrant]:                 https://www.vagrantup.com
[vagrant-virtualbox-iso]:  https://www.packer.io/docs/builders/virtualbox-iso.html
[packer-env-vars]:         https://www.packer.io/docs/other/environment-variables.html
[rubocop]:                 https://github.com/rubocop-hq/rubocop
[shellcheck]:              https://github.com/koalaman/shellcheck
