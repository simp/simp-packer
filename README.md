<!-- vim-markdown-toc GFM -->

* [Overview](#overview)
* [Setup](#setup)
* [Usage](#usage)
  * [Environment Variables](#environment-variables)
  * [Define A Test](#define-a-test)
  * [Run The Test](#run-the-test)
    * [Output](#output)
    * [Overview Of The Tests](#overview-of-the-tests)
      * [The Build Section](#the-build-section)
      * [The Provisioning Section](#the-provisioning-section)
* [The Vagrant File](#the-vagrant-file)
* [TODO](#todo)

<!-- vim-markdown-toc -->

## Overview

[Packer][packer] configuration to build a [Vagrant][vagrant] box from
a [SIMP][simp] ISO and then run tests that require a full SIMP install.

`simp-packer` supports SIMP >= 6.0.0-0.

## Setup

Requirements:

* [VirtualBox](https://www.virtualbox.org/wiki/Downloads)
* [Vagrant](https://www.vagrantup.com/downloads.html)
* [Packer](https://www.packer.io/downloads.html) is distributed as a binary.

  - Ensure the binary is in your `$PATH` and comes before any other packer
    executables on the system (e.g., `export PATH="/path/to/packer:$PATH"`).
  - `simp-packer` 2.* requires `packer` version 1.2.4 or later. This update is
    to support UEFI boot of SIMP servers. Since VirtualBox does not support
    UEFI tftpboot, the SIMP clients will use legacy BIOS boot.
* A SIMP ISO. Either an official release or one generated by
  [simp-core](https://github.com/simp/simp-core) build commands.

## Usage

### Environment Variables

:warning: Document this section

### Define A Test

Create a test directory and include the following files:

* `vars.json`:  The JSON file corresponding with the SIMP ISO.  Contains
  variables that point to the ISO, the ISO checksum, the name of the
  distribution ISO, and the `root` password. Samples can be found in
  `samples/<sample>/vars.json`.
* `simp_conf.yaml`:  YAML generated by `simp config`.  You can use a copy of
  one from a previous build or edit one from from
  `samples/<sample>/simp_conf.yaml`. Puppet server and FIPS configurations will
  be overridden by `simp_config.rb` and `packer.yaml`.
* `packer.yaml`:  Overrides defaults set in `simp_config.rb`.  Packer requires
  this file (even if you don't want to override defaults). Samples can be found
  in `samples/<sample>/packer.yaml`.  For CentOS 6 builds, you **MUST** change
  the `nat_interface` and `host_only_interface` to `eth0` and `eth1`,
  respectively.

Defaults:

- The Puppet server's IP will be X.X.X.7
- DHCP and DNS are set up to contain `server21.domain.name` to
  `server29.domain.name`, and `ws30.domain.name` to `ws39.domain.name`. The
  machine `server21` will have IP X.X.X.21 and MAC address of
  XX:XX:XX:XX:XX:21, and so on.
- The default password for everything is `P@ssw0rdP@ssw0rd`. You can change the
  default in `vars.json` with `new_password`.  However, at this time, there is
  no mechanism to change the LDAP Password.
- Configures the SIMP server to be an LDAP server.  It will set the `basedn `to
  match what you have in the `packer.yaml` for `domain` or use the default.  It
  sets up `user1`, `user2`, `admin1`, and `admin2` LDAP users. `admin1` and
  `admin2` are in the `administrators` group.
- The default distribution ISO path is `/net/ISO/Distribution_ISOs`. It is hard
  coded in `simp.json.template` right now.

### Run The Test

`TMPDIR=/some/tmp/dir ./simp_packer_test.sh /path/to/test/directory`

- `simp_packer_test.sh` must be run from the top level of the `simp-packer`
  directory.
- `packer` uses around twice the space of the virtual image footprint when
  building, so ensure `TMPDIR` has sufficient space.  `TMPDIR` defaults to
  `/tmp` which is not (usually) large enough.

#### Output

- A working directory will be created under the test directory, where all the
  scripts, manifests, and files are kept. It is erased on completion of the
  test, but can be preserved with `SIMP_PACKER_save_WORKINGDIR=true`.
- A time-stamped log file is created in the top level of the test directory and
  all the log output from `packer` is copied there. If the `packer` build
  fails, it is renamed from `<date>.log` to `<date>.log.errors`.
- A Vagrant box with its VagrantFile will be located in the directory defined
  by the `packer.yaml file` `output_directory` (default is
  `<testdirectory>/OUTPUT`).

#### Overview Of The Tests

##### The Build Section

- Installs the ISO
- Adds the `vagrant` user
- Sets `root`'s umask
- Configures the network to start up a boot time
- Changes the passwords for `simp` and `root`
- Updates the `sudoers` file so `simp` user can sudo without a password and
  without a tty

##### The Provisioning Section

Runs a suite of tests:

- Checks that FIPS was enabled/disabled per configuration.
- Runs `simp config` and `simp bootstrap`.
- Installs a manifest that configures the `vagrant` user so you can `vagrant
  ssh` once the box is built, configures `simp` user so `packer` can continue
  working
- Reboots and runs Puppet a couple of times.
- Ensures that the build of the puppetserver is successful and the puppetserver
  up and running and listening on the ports configured in `simp_conf.yaml`.
- Verifies that FIPS is setting match across the `simp_conf.yaml`, the
  `simp_config_settings.yaml` and the operational environment.
- Checks that selinux is set to `enforcing` (the default for simp.)
- If `simp_crypt_disk` is used in the `simp.conf`, it verifies that the disk is
  encrypted.
- Verifies that `/`, `/var/`,`/var/audit` are separate partitions.
- Checks that the port in `puppet.conf` file matches the port in
  `simp_conf.yaml`

If the tests pass, it will configure the Puppet server.  The `simpsetup`
manifest is run via `puppet apply`.  It is run once so that if you make changes
later on they are not overwritten. This manifest does the following:

- Sets up the kickstart files
- Sets up DNS
- Sets up TFTP manifests
- Runs the FakeCA `togen` script to generate SIMP application certificates for
  the SIMP server and all the clients pre-configured in DHCP and DNS.
- Adds users and groups into LDAP
- Sets up autosign to be `*.<domain name>`, so kickstarted systems will get
  their Puppet certificates autosigned.
- Runs scripts that edit the `site.pp` file to create some hostgroups and the
  SIMP server's hiera file to include kickstart and tftpboot classes.
- Copies into the `site` module, but does not use, other useful manifests site
  such as `workstation.pp` and `nfs.pp`.  These manifests will be refined as
  the test suite is expanded.
- Runs puppet once more

The post-processor then exports the VirtualBox to a Vagrant box and removes the
output directory.

## The Vagrant File

- The `vagrant` users password is `vagrant`.
- The Vagrant file is not wrapped in the Vagrant box so the network settings
  can be seen. Vagrant is not easily configured to check if a vbox hostonly
  network exists; you will have to ensure the network exists before running
  `vagrant up`.
- You can change the network name in the Vagrant file.
- The Vagrant file does not configure the machine to use the IP address.  You
  can turn it on, but changing the IP address will mess up the puppet server.
- Directory sharing is enabled.

## TODO

Tests to add:

- Test if the SIMP server's YUM repos are setup and working. These are the
  repos the SIMP clients are configured to use.
- Check if puppet is actually running on the port you specified using `netstat`
  or `ss`.
- Add one last puppet run in at the end and check that it returns 0.  Since all
  services including DNS should be set up, nothing should change at that
  point.)

Features to add:

- Add an Environment variable in to allow it to create the box even if tests
  fails.
- Kickstart a server and client to go with the box.
- Make the location of the distribution ISO configurable.  Right now it is
  hardcoded to be `/net/ISO/Distribution_ISOs`
- Validate input from `packer.yaml` and don't fail if that file does not exist,
  because you should be able to run with all the defaults.

Documentation to add:

- Environment Variables

Clean it up:

- Change the `packer.yaml` settings to match the names used in the `simp.json`
  file to make things more consistent and will allow code simplification.
- Merge the `simp_config.rb` and `simp_packer_tests.sh` into one ruby script
  and clean it up.
- Delete the Virtualbox host-only network if we created it

[packer]: https://packer.io
[vagrant]: https://www.vagrantup.com
[SIMP]: https://github.com/    NationalSecurityAgency/SIMP
