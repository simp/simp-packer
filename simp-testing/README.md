## SIMP Packer manifests

#### Table of Contents

* [Overview](#overview)
* [Setup](#setup)
* [Usage](#usage)
* [Environment Variables](#environment-variables)
* [Define A Test](#define-a-test)
* [Run The Test](#run-the-test)
* [The Vagrant File](#the-vagrant-file)
* [TODO](#todo)

### Overview

[Packer](https://packer.io) configuration to build a [Vagrant](https://www.vagrantup.com/) box from a [SIMP](https://github.com/NationalSecurityAgency/SIMP) ISO and run tests that require a full SIMP install.

simp-packer supports SIMP >= 6.0.0-0

### Setup

Requirements:
  - [VirtualBox](https://www.virtualbox.org/wiki/Downloads)
  - [Vagrant](https://www.vagrantup.com/downloads.html)
  - [Packer](https://www.packer.io/downloads.html) is distributed as a binary.
    Ensure the binary is in your `$PATH` and comes before any other packer
    executables on the system `PATH="/path/to/packer:$PATH"`
  - A SIMP ISO. Either an official release or one generated with build:auto.

### Usage

#### Environment Variables

#### Define A Test

Create a test directory and include the following files:
  - `vars.json`:  The JSON file corresponding with the SIMP ISO.  Contains
    variables that point to the ISO, the ISO checksum, the name of the
    distribution ISO, and the root password. Samples can be found in
    `samples/<sample>/vars.json`
  - `simp_conf.yaml`:  YAML generated by simp config.  You can use a copy of
    one from a previous build or edit one from from
    `samples/<sample>/simp_conf.yaml`. Puppet server and FIPS configurations
     will be overridden by `simp_config.rb` and `packer.yaml`
  - `packer.yaml`:  Overrides defaults set in `simp_config.rb`.  Packer
    requires this file (even if you don't want to override defaults). Samples
    can be found in `samples/<sample>/packer.yaml`.  For CentOS 6 builds,
    you need to change the `NAT_INTERFACE` and `HOST_ONLY_INTERFACE` to eth0
    and eth1, respectively.

Defaults:
  - The Puppet server's IP will be X.X.X.7
  - DHCP and DNS are set up to contain server21.domain.name to
    server29.domain.name, and ws30.domain.name - ws39.domain.name. The machine
    server21 will have IP X.X.X.21 and mac address of XXXXXXXXXX21, and so on.
  - The default password for everything is P@ssw0rdP@ssw0rd. You can change the
    default in `vars.json` with new_password.  Changing the LDAP Password
    doesn't work at this time.
  - It only works for systems with LDAP set up.  It will change
    the basedn to match what you have in packer.yaml for DOMAIN or use
    the default.  It sets up user1, user2, admin1, admin2.
  - The default distribution ISO path is `/net/ISO/Distribution_ISOs`.
    It is hard coded in `simp.json.template` right now.

#### Run The Test

`TMPDIR=/some/tmp/dir ./simp_packer_test.sh /path/to/test/directory`

-  `simp_packer_test.sh` must be run from the top level of the `simp-testing`
  directory.
- Packer uses around twice the space of the virtual image footprint when
  building, so ensure TMPDIR has sufficient space.  TMPDIR defaults to
  /tmp which is not (usually) large enough.

##### Output

- A working directory will be created  under the test directory, where all
  the scripts, manifests, and files are kept. It is erased on completion of
  the test, but can be preserved with `SIMP_PACKER_save_WORKINGDIR=true`.
- A time-stamped log file is created in the top level of the test directory and
  all the output from packer is copied there. If the packer build fails, it is
  renamed from <date>.log to <date>.log.errors.
- A vagrant box with VagrantFile will be located in the directory defined
  by the packer.yaml file `OUTPUT_DIRECTORY` (default is
  `<testdirectory>/OUTPUT`).

##### Overview Of The Tests

###### The Build Section

- Installs the ISO
- Adds the vagrant user
- Sets root's umask
- Configures the network to start up a boot time
- Changes the passwords for simp and root
- Updates the sudo file so simp user can sudo without a password and without
  a tty

###### The Provisioning Section

Runs a suite of tests:

- Checks that FIPS was enabled/disabled per configruation
- Runs simp config and simp bootstrap.
- Installs a manifest that configures the vagrant user so you can vagrant ssh
  once the box is built and configures simp user so packer can continue working
- Reboots and run Puppet a couple of times
- Ensures that the build of the puppet server is successful and is up and
  running and listening on the ports configured in `simp_conf.yaml`
- Verifies that FIPS is setting match across the `simp_conf.yaml`, the
  `simp_config_settings.yaml` and the operational environment.
- Checks that selinux is set to enforcing (the default for simp.)
- If `simp_crypt_disk` is used in the `simp.conf`, it verifies that the disk is
  encrypted.
- Verifies that `/`, `/var/`,`/var/audit` are separate partitions.
- Checks that the port in puppet conf file matches the port in `simp_conf.yaml`

If the tests pass, it will configure the Puppet server.  The `simpsetup` manifest
is run via `puppet apply`.  It is run once so that if you make changes later on
they are not over written.

- Setup the kickstart files
- Sets up dns
- Sets up tftp manifests
- togen certificates for all the servers and clients
- Adds users and groups into LDAP
- Sets up autosign to be `*.<domain name>` so kickstarted systems will get
  their puppet cert autosigned.
- Scripts are run that edit the site.pp file to create some hostgroups and
  edit the hiera files to include kickstart and tftpboot.
- I have copied over some manifests like workstation.pp and nfs.pp but they
  have not been tested and are not configured at this time.
- It then runs puppet once more

The post-processor then exports the virtualbox to a vagrant box and removes the
output directory.

### The Vagrant File

- The vagrant password is vagrant.
- The Vagrant file is not wrapped in the Vagrant box so the network settings
  can be seen. Vagrant is not easily configured to check if a vbox hostonly
  network exists; you will have to ensure the network exists before running
  vagrant up.
- You can change the network name in the Vagrant file.
- The Vagrant file does not configure the machine to use the IP address.  You
  can turn it on, but changing the IP address will mess up the puppet server.
- Directory sharing is enabled.

### TODO

Tests to add:

- test if master is yum that yum is set up and working.
- check if puppet is actually running on the port you specified. (netstat or ss)
- add one last puppet run in at the end and check that it returns 0 (dns and all
  that should be set up and nothing chould change at that point.)

Features to add:

- Add an Environment variable in to allow it to create the box even if tests fails.
- Kickstart a server and client to go with the box.
- The distribution ISO is hardcoded to be in `/net/ISO/Distribution_ISOs`.  Make
  that configurable.
- validate input from packer.yaml and don't fail if it does not exist because you
  can run with all the defaults.

Documentation to add:

- Environment Variables

Clean it up:

- Move the Vagrant file into the Output directory.
- Change the packer.yaml settings to match the names used in the simp.json file
  to make things more consistent and will allow code simplification.
- Merge the `simp_config.rb` and `simp_packer_tests.sh` into one ruby script
  and clean it up.
- Delete the Virtualbox Hostonly network if we created it
